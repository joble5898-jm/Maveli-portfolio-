 <!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maaveli's Royal Portfolio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
    <style>
        /* Global Styles */
        :root {
            --bg-start: #112a14;
            --bg-end: #2a112a;
            --text-color: #d8c4b2; /* Lighter gold */
            --card-bg: rgba(29, 13, 29, 0.5); /* Dark purple transparent */
            --card-border: rgba(216, 196, 178, 0.3); /* Lighter gold transparent */
            --button-bg: #e59c11; /* Amber */
            --button-hover: #b47a0d; /* Darker Amber */
            --accent-color: #d8c4b2;
            --chat-bg: #122b13;
            --chat-bot-msg: #2e4d41;
        }

        .cosmic-mode {
            --bg-start: #0b0f26;
            --bg-end: #1a2035;
            --text-color: #d1d9e2;
            --card-bg: rgba(26, 32, 53, 0.6);
            --card-border: rgba(209, 217, 226, 0.3);
            --button-bg: #6366f1; /* Indigo */
            --button-hover: #4338ca; /* Darker Indigo */
            --accent-color: #818cf8; /* Light blue-violet */
            --chat-bg: #2a2c42;
            --chat-bot-msg: #3f456c;
        }
        
        body {
            font-family: 'IM Fell English', serif;
            background: linear-gradient(to bottom, var(--bg-start), var(--bg-end));
            color: var(--text-color);
            overflow-x: hidden;
            transition: background 0.5s ease-in-out, color 0.5s ease-in-out;
        }

        /* Optimized Fade-in-up effect for sections on scroll */
        .fade-in-up {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.8s ease-out, transform 0.8s ease-out;
            will-change: opacity, transform;
        }
        .fade-in-up.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Text shadow to simulate old ink */
        h1, h2, h3 {
            text-shadow: 1.5px 1.5px 2px rgba(0, 0, 0, 0.3);
        }
        .cosmic-mode h1, .cosmic-mode h2, .cosmic-mode h3, .cosmic-mode p, .cosmic-mode a, .cosmic-mode li, .cosmic-mode button, .cosmic-mode input, .cosmic-mode textarea {
            text-shadow: none;
        }
        
        /* Flower animation */
        @keyframes flower-fall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 0; }
            10% { opacity: 0.8; }
            100% { transform: translateY(calc(100vh + 100px)) rotate(360deg); opacity: 0; }
        }

        .flower {
            position: fixed;
            font-size: 20px;
            pointer-events: none;
            z-index: 0;
            animation: flower-fall linear infinite;
        }

        /* Slideshow navigation buttons */
        .prev, .next {
            cursor: pointer;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            padding: 1rem;
            color: white;
            font-weight: bold;
            font-size: 1.5rem;
            transition: 0.3s;
            border-radius: 0.5rem;
            user-select: none;
            background-color: rgba(0, 0, 0, 0.4);
        }
        .next { right: 1rem; }
        .prev { left: 1rem; }
        .prev:hover, .next:hover { background-color: rgba(0, 0, 0, 0.8); }

        /* Chatbot and Translator sidebar */
        .chat-sidebar, .translator-sidebar {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            max-width: 400px;
            height: 100vh;
            background-color: var(--chat-bg);
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.3);
            transition: right 0.6s cubic-bezier(0.25, 0.8, 0.25, 1);
            z-index: 50;
            display: flex;
            flex-direction: column;
        }
        .chat-sidebar.open, .translator-sidebar.open { right: 0; }

        .chat-messages {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
             padding: 0.75rem 1rem;
             border-radius: 0.5rem;
             max-width: 80%;
             word-wrap: break-word;
        }

        .message.bot {
            background-color: var(--chat-bot-msg);
            color: var(--text-color);
            align-self: flex-start;
            border-bottom-left-radius: 0rem;
        }
        .message.user {
             background-color: var(--button-bg);
             color: white;
             align-self: flex-end;
             border-bottom-right-radius: 0rem;
        }
        
        .cosmic-mode .chat-sidebar, .cosmic-mode .translator-sidebar { background-color: #1a2035; box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1); }
        .cosmic-mode .message.bot { background-color: #3f456c; color: var(--text-color); }
        .cosmic-mode .message.user { background-color: var(--button-bg); }
        
        .message.new {
            opacity: 0;
            animation: fadeIn 0.5s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Hero Aura Animation */
        .hero-aura {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }
        .hero-aura::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, var(--accent-color) 0%, transparent 70%);
            animation: pulse 4s infinite ease-in-out;
            opacity: 0.15;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(0.9); opacity: 0.1; }
            50% { transform: scale(1.1); opacity: 0.2; }
        }

        /* Glassmorphism Cards */
        .glass-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
        }
        .cosmic-mode .glass-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
        }

        .citation {
            font-size: 0.75rem;
            color: #a0a0a0;
            margin-top: 0.5rem;
        }
        
        .cosmic-mode .citation {
            color: #b0b8c6;
        }
        
        .click-effect {
            position: absolute;
            font-size: 20px;
            pointer-events: none;
            z-index: 99;
            transform: translate(-50%, -50%);
            animation: burst 1s forwards;
            opacity: 0;
        }

        @keyframes burst {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }

        .loading-animation {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        .cosmic-mode .loading-animation {
            border-color: rgba(209, 217, 226, 0.3);
            border-top-color: #d1d9e2;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hamburger-menu {
            position: fixed;
            top: 0;
            left: -100%;
            width: 100%;
            max-width: 300px;
            height: 100vh;
            background-color: var(--chat-bg);
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.3);
            transition: left 0.4s ease-in-out;
            z-index: 60;
            display: flex;
            flex-direction: column;
            padding: 2rem;
            box-sizing: border-box;
        }

        .hamburger-menu.open {
            left: 0;
        }
        
        .cosmic-mode .hamburger-menu { background-color: #1a2035; }
        
        .menu-link {
            padding: 0.75rem 1rem;
            text-decoration: none;
            color: var(--text-color);
            font-size: 1.25rem;
            font-weight: 700;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
            border-bottom: 1px solid rgba(46, 77, 65, 0.3);
        }

        .menu-link:hover {
            background-color: var(--card-bg);
        }
        .cosmic-mode .menu-link { border-bottom: 1px solid rgba(209, 217, 226, 0.1); }

        /* Continuous Slideshow styles */
        .continuous-slideshow-container {
            overflow: hidden;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }
        .continuous-slideshow-track {
            display: flex;
            width: 200%; /* Changed for a 2-set loop */
            animation: scroll 30s linear infinite;
        }
        .continuous-slideshow-slide {
            flex: 0 0 calc(100% / 3); /* Display 3 slides at a time */
            padding: 0.5rem;
        }

        @keyframes scroll {
            0% { transform: translateX(0%); }
            100% { transform: translateX(-50%); }
        }
        
        /* New animations for chat toggle button */
        @keyframes subtle-pulse {
            0%, 100% { transform: scale(1); filter: drop-shadow(0 0 5px var(--button-bg)); }
            50% { transform: scale(1.1); filter: drop-shadow(0 0 15px var(--button-bg)); }
        }
        
        .chat-toggle-btn {
            animation: subtle-pulse 2s ease-in-out infinite;
            transition: transform 0.2s ease-in-out, opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
        }
        
        /* New animations for translator toggle button */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .translator-toggle-btn {
            animation: float 3s ease-in-out infinite;
            transition: transform 0.2s ease-in-out;
        }
        
        /* Dark/Light Mode Toggle */
        .theme-toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        .theme-toggle-btn:hover {
            transform: scale(1.1);
        }
        .theme-toggle-btn svg {
            transition: transform 0.5s ease-in-out;
        }
        .cosmic-mode .theme-toggle-btn svg {
            transform: rotate(180deg);
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 70;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.open {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 1.5rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            position: relative;
            color: var(--text-color);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal.open .modal-content {
            transform: scale(1);
        }

        .cosmic-mode .modal-content {
            background-color: #1a2035;
            color: #d1d9e2;
        }
        .cosmic-mode input, .cosmic-mode textarea, .cosmic-mode .chat-input {
            color: #d1d9e2 !important;
            background-color: #2a2c42;
            border-color: #3f456c;
        }
        
        .chatbot-icon {
            width: 50px; 
            height: 50px;
        }

        /* Tic-Tac-Toe Game Styles */
        #tic-tac-toe-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            width: 300px;
            height: 300px;
            margin: 20px auto;
            transition: pointer-events 0.3s ease;
        }
        .cell {
            background: var(--chat-bot-msg);
            border: 2px solid var(--card-border);
            border-radius: 0.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .cell:hover {
            background: var(--card-bg);
        }
        .cosmic-mode .cell {
             background: var(--chat-bot-msg);
             border-color: var(--card-border);
        }
        .cosmic-mode .cell:hover {
            background: var(--card-bg);
        }

        /* Boat Race Styles */
        #race-track {
             background-image: linear-gradient(to right, #1e3a8a, #3b82f6);
        }
        .cosmic-mode #race-track {
             background-image: linear-gradient(to right, #1e1b4b, #4338ca);
        }
        .boat {
            position: absolute;
            left: 10px;
            font-size: 2.5rem;
            transition-property: left;
            transition-timing-function: cubic-bezier(0.6, -0.28, 0.735, 0.045); /* ease-in-back */
        }
        .boat.racing {
            left: calc(100% - 60px);
        }


    </style>
</head>
<body class="bg-[#112a14] text-amber-100">

    <!-- Cosmic Light Canvas -->
    <canvas id="cosmic-canvas" class="fixed top-0 left-0 w-full h-full -z-10"></canvas>

    <!-- Flower Container (fixed position for animation) -->
    <div id="flower-container" class="fixed top-0 left-0 w-full h-full pointer-events-none z-0 overflow-hidden"></div>

    <!-- Header Section -->
    <header class="bg-gradient-to-r from-[var(--bg-start)] to-[var(--bg-end)] shadow-lg text-white py-12 px-6 text-center rounded-b-3xl relative z-10 overflow-hidden">
        <div class="hero-aura"></div>
        <!-- Buttons Container -->
        <div class="absolute top-6 left-6 z-20">
            <button id="hamburger-btn" class="p-2 rounded-full bg-[#1d0d1d] bg-opacity-50 text-white hover:bg-opacity-80 transition-colors">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
        </div>
        <div class="absolute top-6 right-6 z-20 flex space-x-2">
            <!-- New Theme Toggle Button -->
            <button id="theme-toggle-btn" class="theme-toggle-btn p-2 rounded-full bg-[#1d0d1d] bg-opacity-50 text-white hover:bg-opacity-80 transition-colors">
                   <svg id="theme-icon" class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
            </button>
        </div>
        <!-- Maaveli's Logo -->
        <div class="mb-4 relative z-10">
             <img src="https://firebasestorage.googleapis.com/v0/b/app-maaveli-s-royal-portfoli-169c9.appspot.com/o/1000006025.jpg?alt=media&token=8cd55754-bf51-4ea2-99b7-9ee5706afb87" alt="Maaveli's Royal Logo" class="mx-auto w-24 h-24 rounded-full border-4 border-amber-300 shadow-xl">
        </div>
        <h1 class="text-5xl md:text-6xl font-extrabold tracking-tight relative z-10">Maaveli's Royal Portfolio</h1>
        <p class="mt-4 text-xl md:text-2xl font-light relative z-10">Monarch of the Golden Age, Hero of the Three Worlds</p>
    </header>

    <!-- Main Content Container with bottom padding for fixed buttons -->
    <main class="container mx-auto px-4 py-8 md:py-16 relative z-10 pb-40">
        <!-- About Me Section -->
        <section id="about" class="fade-in-up glass-card p-8 md:p-12 mb-12 flex flex-col md:flex-row items-center justify-center space-y-6 md:space-y-0 md:space-x-12">
            <div class="w-full md:w-1/2 flex justify-center">
                <img src="https://source.unsplash.com/600x600/?king-mahabali" alt="A regal portrait of the King." class="w-full h-auto rounded-3xl border-4 border-amber-300 shadow-xl transition-transform hover:scale-105">
            </div>
            <div class="w-full md:w-1/2 flex flex-col items-center">
                <h2 class="text-3xl md:text-4xl font-bold text-amber-300 mb-6">About the King</h2>
                <p id="about-text" class="text-lg leading-relaxed text-amber-200">
                    Hailed as the most generous and just ruler to ever grace the earth, my reign over Kerala was an era of unparalleled prosperity. Under my watch, my kingdom knew no want, no deceit, and no sorrow. Every door was an open door, every heart was content. While my tale is one of divine intervention and a journey to the netherworld, my annual return for Onam proves that true leadership is a bond that transcends dimensions. My motto? "Serve the people, and the people will forever serve you... a delicious feast!"
                </p>
                 <div class="flex justify-center mt-6">
                    <button id="tts-button" class="px-6 py-2 bg-amber-700 text-white font-semibold rounded-full hover:bg-amber-800 transition-colors">✨ Majesty in Words✨</button>
                    <div id="tts-loading" class="mt-2 hidden ml-4">
                        <div class="loading-animation"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Heroic Deeds Section -->
        <section id="deeds" class="fade-in-up mb-12">
            <h2 class="text-3xl md:text-4xl font-bold text-amber-300 mb-6 text-center">Heroic Deeds</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="glass-card p-6 transform transition-transform hover:scale-105">
                    <h3 class="text-xl font-semibold text-amber-100 mb-2">The Golden Reign</h3>
                    <p class="text-amber-200">Established an era of perfect harmony, where all were equal, and poverty was a forgotten word. No thieves, no lies, just pure golden goodness.</p>
                </div>
                <div class="glass-card p-6 transform transition-transform hover:scale-105">
                    <h3 class="text-xl font-semibold text-amber-100 mb-2">The Ultimate Sacrifice</h3>
                    <p class="text-amber-200">Honored a promise to Vamana (Lord Vishnu in disguise), giving up my kingdom and accepting banishment to the netherworld to uphold my word.</p>
                </div>
                <div class="glass-card p-6 transform transition-transform hover:scale-105">
                    <h3 class="text-xl font-semibold text-amber-100 mb-2">Annual Royal Visit</h3>
                    <p class="text-amber-200">The most anticipated event of the year! I make a grand return every Onam to witness the joy and prosperity of my people.</p>
                </div>
            </div>
        </section>
        
        <!-- Onam Calendar Section (New) -->
        <section id="onam-calendar" class="fade-in-up mb-12 p-8 rounded-3xl bg-[#1d0d1d]">
            <h2 class="text-3xl md:text-4xl font-bold text-amber-300 mb-6 text-center">ഓണം കലണ്ടർ</h2>
            <div id="calendar-content" class="text-center text-lg text-amber-200 min-h-[5rem]">
                <!-- Calendar will be generated here -->
                 <p>Click the button to reveal the dates for the next Onam celebration!</p>
            </div>
            <div class="text-center mt-4">
                <button id="generate-calendar-btn" class="px-6 py-2 bg-[var(--button-bg)] text-white font-semibold rounded-full hover:bg-[var(--button-hover)] transition-colors">✨ Generate Next Onam Calendar ✨</button>
            </div>
        </section>

        <!-- Royal Showcase & Favorites Section with Slideshow -->
        <section id="showcase" class="fade-in-up mb-12">
            <h2 class="text-3xl md:text-4xl font-bold text-amber-300 mb-6 text-center">Royal Showcase</h2>
            <div class="slideshow-container relative max-w-xl mx-auto overflow-hidden rounded-3xl shadow-2xl">
                <div id="slides-wrapper" class="flex transition-transform duration-500 ease-in-out">
                    <div class="w-full flex-shrink-0">
                        <img src="https://source.unsplash.com/1200x800/?kerala,parippu-payasam" alt="A bowl of traditional Parippu Payasam." class="w-full h-auto rounded-t-3xl">
                        <div class="p-6 bg-[var(--chat-bg)] rounded-b-3xl">
                            <h3 class="text-2xl font-semibold text-amber-100 mb-2">My Favorite Payasam</h3>
                            <p class="text-amber-200">My kingdom's finest Parippu Payasam, made with jaggery and coconut milk. A dish so divine, even the gods would trade their ambrosia for a bowl!</p>
                             <div class="flex justify-center mt-4">
                                <button onclick="generatePayasamRecipe()" class="px-6 py-2 bg-[var(--button-bg)] text-white font-semibold rounded-full hover:bg-[var(--button-hover)] transition-colors">✨ Get the Royal Recipe ✨</button>
                            </div>
                        </div>
                    </div>
                    <div class="w-full flex-shrink-0">
                        <img src="https://source.unsplash.com/1200x800/?kerala,onam-sadya" alt="A grand Onam Sadya served on a banana leaf." class="w-full h-auto rounded-t-3xl">
                        <div class="p-6 bg-[var(--chat-bg)] rounded-b-3xl">
                            <h3 class="text-2xl font-semibold text-amber-100 mb-2">The Grand Sadya</h3>
                            <p class="text-amber-200">A masterpiece of culinary excellence! 26 dishes of pure bliss, served on a banana leaf. My favorite part of coming home.</p>
                        </div>
                    </div>
                    <div class="w-full flex-shrink-0">
                        <img src="https://source.unsplash.com/1200x800/?kerala,pookkalam" alt="An intricate and colorful floral carpet (Pookkalam)." class="w-full h-auto rounded-t-3xl">
                        <div class="p-6 bg-[var(--chat-bg)] rounded-b-3xl">
                            <h3 class="text-2xl font-semibold text-amber-100 mb-2">Royal Pookkalam</h3>
                            <p class="text-amber-200">My royal court's florists are second to none. The intricate flower carpets they create for my return are a sight to behold.</p>
                        </div>
                    </div>
                </div>
                <button class="prev" onclick="plusSlides(-1)">&#10094;</button>
                <button class="next" onclick="plusSlides(1)">&#10095;</button>
            </div>
        </section>
        
        <!-- Maveli's Royal Gallery (New Continuous Slideshow) -->
        <section id="maveli-gallery" class="fade-in-up mb-12">
            <h2 class="text-3xl md:text-4xl font-bold text-amber-300 mb-6 text-center">മാവേലിയുടെ രാജകീയ ഗാലറി</h2>
            <div class="continuous-slideshow-container max-w-4xl mx-auto">
                <div class="continuous-slideshow-track">
                    <div class="continuous-slideshow-slide">
                        <img src="https://source.unsplash.com/1200x800/?kerala,king,throne" alt="A regal king sitting on a throne." class="w-full rounded-2xl">
                    </div>
                    <div class="continuous-slideshow-slide">
                        <img src="https://source.unsplash.com/1200x800/?kerala,people,festival" alt="People celebrating a festival in Kerala." class="w-full rounded-2xl">
                    </div>
                    <div class="continuous-slideshow-slide">
                        <img src="https://source.unsplash.com/1200x800/?kerala,mythology,story" alt="A mythical scene from Kerala folklore." class="w-full rounded-2xl">
                    </div>
                    <!-- Duplicated slides for seamless loop -->
                    <div class="continuous-slideshow-slide">
                        <img src="https://source.unsplash.com/1200x800/?kerala,king,throne" alt="A regal king sitting on a throne." class="w-full rounded-2xl">
                    </div>
                    <div class="continuous-slideshow-slide">
                        <img src="https://source.unsplash.com/1200x800/?kerala,people,festival" alt="People celebrating a festival in Kerala." class="w-full rounded-2xl">
                    </div>
                    <div class="continuous-slideshow-slide">
                        <img src="https://source.unsplash.com/1200x800/?kerala,mythology,story" alt="A mythical scene from Kerala folklore." class="w-full rounded-2xl">
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Onam Photo & Video Uploader Section -->
        <section id="photo-uploader" class="fade-in-up glass-card p-8 md:p-12 mb-12">
            <h2 class="text-3xl md:text-4xl font-bold text-amber-300 mb-6 text-center">നിങ്ങളുടെ ഓണാഘോഷ ചിത്രങ്ങളും വീഡിയോകളും സമർപ്പിക്കുക</h2>
            <p class="text-center text-lg mb-6 text-amber-200">
                എന്റെ പ്രിയപ്പെട്ട പ്രജകളെ, നിങ്ങളുടെ ഓണാഘോഷ ചിത്രങ്ങൾ എനിക്ക് സമർപ്പിക്കുക. ഈ പേജിൽ അവ ഞാൻ പ്രദർശിപ്പിക്കാം!
            </p>
            <div class="flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4">
                <input type="file" id="onam-photo-video-input" accept="image/*" class="w-full md:w-auto text-amber-200 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-[var(--button-bg)] file:text-white hover:file:bg-[var(--button-hover)]">
                <button id="upload-photo-btn" class="px-6 py-2 bg-[var(--button-bg)] text-white font-semibold rounded-full hover:bg-[var(--button-hover)] transition-colors">
                    അപ്‌ലോഡ് ചെയ്യുക
                </button>
            </div>
            <div id="upload-status" class="mt-4 text-center"></div>
            <p class="text-center text-sm text-amber-400 mt-2">
                Note: Photos are stored in a public database for everyone to see.
            </p>
            <div id="uploaded-photos-container" class="mt-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Uploaded photos will be displayed here -->
            </div>
        </section>

        <!-- Race Boat Section (New) -->
        <section id="race-boat" class="fade-in-up mb-12 p-8 rounded-3xl bg-[var(--card-bg)] overflow-hidden">
             <h2 class="text-3xl md:text-4xl font-bold text-amber-300 mb-6 text-center">വള്ളംകളി (Royal Boat Race)</h2>
             <div id="race-track" class="relative h-64 rounded-lg p-4 border-2 border-[var(--card-border)]">
                 <!-- Boats will be added here by JS -->
             </div>
             <div class="text-center mt-6">
                 <button id="start-race-btn" class="px-8 py-3 bg-[var(--button-bg)] text-white font-semibold rounded-full hover:bg-[var(--button-hover)] transition-colors">
                     Start the Race!
                 </button>
             </div>
             <div id="race-result" class="text-center text-2xl font-bold mt-4 h-8"></div>
         </section>

        <!-- Onam Games Section (New) -->
        <section id="onam-games" class="fade-in-up mb-12 p-8 rounded-3xl bg-[var(--card-bg)]">
            <h2 class="text-3xl md:text-4xl font-bold text-amber-300 mb-6 text-center">ഓണക്കളികൾ</h2>
            <div id="games-content" class="text-center text-lg text-amber-200 min-h-[5rem]">
                 <p>Looking for some festive fun? Let the King suggest some traditional games!</p>
            </div>
             <div class="text-center mt-4">
                <button id="generate-games-btn" class="px-6 py-2 bg-[var(--button-bg)] text-white font-semibold rounded-full hover:bg-[var(--button-hover)] transition-colors">✨ Suggest Traditional Games ✨</button>
            </div>
        </section>
        
        <!-- Tic-Tac-Toe Game Section -->
        <section id="tictactoe-game" class="fade-in-up glass-card p-8 md:p-12 mb-12">
            <h2 class="text-3xl md:text-4xl font-bold text-amber-300 mb-6 text-center">Thattil Kutti Kali (Tic-Tac-Toe)</h2>
            <p class="text-center text-lg mb-6 text-amber-200">A game of wits for my clever subjects! You are the Pookkalam (🌸).</p>
            <div class="flex justify-center space-x-4 mb-4">
                <button id="mode-pvp" class="px-4 py-2 bg-[var(--button-hover)] text-white font-semibold rounded-full transition-colors">Play a Friend</button>
                <button id="mode-pve" class="px-4 py-2 bg-[var(--button-bg)] text-white font-semibold rounded-full hover:bg-[var(--button-hover)] transition-colors">Play Maveli</button>
            </div>
            <div id="game-status" class="text-center text-2xl font-bold mb-4 h-8"></div>
            <div id="tic-tac-toe-board">
                <div data-cell-index="0" class="cell"></div>
                <div data-cell-index="1" class="cell"></div>
                <div data-cell-index="2" class="cell"></div>
                <div data-cell-index="3" class="cell"></div>
                <div data-cell-index="4" class="cell"></div>
                <div data-cell-index="5" class="cell"></div>
                <div data-cell-index="6" class="cell"></div>
                <div data-cell-index="7" class="cell"></div>
                <div data-cell-index="8" class="cell"></div>
            </div>
            <div class="text-center mt-6">
                <button id="restart-game-btn" class="px-8 py-3 bg-[var(--button-bg)] text-white font-semibold rounded-full hover:bg-[var(--button-hover)] transition-colors">
                    Restart Game
                </button>
            </div>
        </section>


        <!-- Royal Art Generator Section (New) -->
        <section id="art-generator" class="fade-in-up glass-card p-8 md:p-12 mb-12">
            <h2 class="text-3xl md:text-4xl font-bold text-amber-300 mb-6 text-center">രാജകീയ ചിത്രരചനാ യന്ത്രം</h2>
            <p class="text-center text-lg mb-6 text-amber-200">
                നിങ്ങളുടെ ഭാവനക്കനുസരിച്ച് പുതിയ ചിത്രങ്ങൾ നിർമ്മിക്കാൻ ഈ യന്ത്രം ഉപയോഗിക്കാം. മാവേലിയെക്കുറിച്ചുള്ള ഒരു വിവരണം നൽകുക!
            </p>
            <div class="flex flex-col items-center justify-center space-y-4">
                <input type="text" id="art-prompt" class="w-full max-w-lg rounded-md border-gray-300 shadow-sm p-2 text-gray-900" placeholder="ഉദാഹരണം: കേരളത്തിലെ ഒരു ആധുനിക മാവേലി" aria-label="Enter a prompt for the image generator">
                <button onclick="generateImage()" class="px-6 py-2 bg-[var(--button-bg)] text-white font-semibold rounded-full hover:bg-[var(--button-hover)] transition-colors">✨ രാജകീയ ചിത്രം നിർമ്മിക്കുക ✨</button>
            </div>
            <div id="image-output" class="mt-8 flex flex-col items-center justify-center">
                <div id="image-loading" class="hidden">
                    <div class="loading-animation"></div>
                    <p class="text-amber-200 mt-2">ചിത്രം വരച്ചുകൊണ്ടിരിക്കുന്നു... അല്പം കാത്തിരിക്കുക!</p>
                </div>
                <img id="generated-image" src="" alt="നിർമ്മിച്ച ചിത്രം ഇവിടെ കാണാം" class="hidden w-full max-w-lg rounded-xl shadow-lg border border-amber-700">
            </div>
        </section>

        <!-- Contact Section -->
        <section id="contact" class="fade-in-up glass-card text-white p-8 md:p-12">
            <h2 class="text-3xl md:text-4xl font-bold text-amber-300 mb-6 text-center">Contact the King</h2>
            <p class="text-center text-lg mb-6 text-amber-200">
                Want to invite the King to your next Onam celebration? He's always ready to hear from his loyal subjects!
            </p>
            <div class="max-w-xl mx-auto">
                <form id="contact-form" class="space-y-4">
                    <div>
                        <label for="name" class="block text-sm font-medium">Your Name</label>
                        <input type="text" id="name" name="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-gray-900" required>
                    </div>
                    <div>
                        <label for="message" class="block text-sm font-medium">Your Royal Wish</label>
                        <textarea id="message" name="message" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-gray-900" required></textarea>
                    </div>
                    <div class="text-center">
                        <button type="submit" class="w-full py-3 px-6 bg-[var(--button-bg)] text-white font-bold rounded-full hover:bg-[var(--button-hover)] transition-colors shadow-lg">
                            Send Message to the King
                        </button>
                    </div>
                </form>
                 <div id="contact-status" class="mt-4 text-center font-semibold"></div>
            </div>
        </section>
    </main>

    <!-- Footer Section -->
    <footer class="bg-[var(--card-bg)] text-white text-center py-6 px-4 rounded-t-3xl mt-12 relative z-10">
        <p class="text-sm">© 2024 The Glorious Reign of Mahabali. All Rights Reserved. (Well, mostly.)</p>
    </footer>

    <!-- Fixed Action Buttons -->
    <div class="fixed bottom-8 right-8 z-40 flex flex-col space-y-4">
        <button id="translator-toggle-btn" class="translator-toggle-btn p-4 rounded-full bg-[var(--button-bg)] text-white shadow-lg hover:bg-[var(--button-hover)] transition-transform hover:scale-110">
            <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 21l5.25-11.25L21 21m-9-3h7.5M3 5.621a48.474 48.474 0 016-.371m0 0c1.12 0 2.233.038 3.334.114M9 5.25V3m3.334 2.364C11.176 10.658 7.69 15.08 3 17.502m9.334-12.138c.896.061 1.785.147 2.666.257m-4.589 8.495a18.023 18.023 0 01-3.827-5.802" />
            </svg>
        </button>
        <button id="chat-toggle-btn" class="chat-toggle-btn p-4 rounded-full bg-[var(--button-bg)] text-white shadow-lg hover:bg-[var(--button-hover)] transition-transform hover:scale-110">
            <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" />
            </svg>
        </button>
    </div>

    <!-- Hamburger Menu Sidebar -->
    <aside id="hamburger-menu" class="hamburger-menu">
        <div class="flex justify-end mb-8">
            <button id="close-menu-btn" class="text-white text-3xl hover:text-gray-400 transition-colors">&times;</button>
        </div>
        <nav class="flex flex-col space-y-2">
            <a href="#onam-calendar" onclick="closeMenu()" class="menu-link">ഓണം കലണ്ടർ</a>
            <button onclick="generateSadyaRecipe(); closeMenu();" class="menu-link text-left">സദ്യയുടെ റെസിപ്പി</button>
            <button onclick="generatePayasamRecipe(); closeMenu();" class="menu-link text-left">പായസത്തിന്റെ റെസിപ്പി</button>
            <a href="#race-boat" onclick="closeMenu()" class="menu-link">വള്ളംകളി</a>
            <a href="#onam-games" onclick="closeMenu()" class="menu-link">ഓണക്കളികൾ</a>
            <a href="#tictactoe-game" onclick="closeMenu()" class="menu-link">Thattil Kutti Kali</a>
            <a href="#maveli-gallery" onclick="closeMenu()" class="menu-link">മാവേലിയുടെ ഗാലറി</a>
            <a href="#photo-uploader" onclick="closeMenu()" class="menu-link">ചിത്രങ്ങളും വീഡിയോകളും</a>
            <button onclick="openTranslator(); closeMenu();" class="menu-link text-left">പരിഭാഷകൻ</button>
            <a href="https://portfolio-blond-kappa-12.vercel.app/" target="_blank" onclick="closeMenu()" class="menu-link">Meet the Founder</a>
        </nav>
    </aside>

    <!-- Translator Sidebar -->
    <aside id="translator-sidebar" class="translator-sidebar p-4">
        <div class="flex justify-between items-center p-4 bg-[var(--chat-bg)] rounded-t-3xl shadow-md border-b border-[var(--card-border)]">
            <h3 class="text-2xl font-bold text-[var(--accent-color)] text-center">പരിഭാഷകൻ</h3>
            <button id="close-translator-btn" class="text-white text-3xl hover:text-gray-400 transition-colors">&times;</button>
        </div>
        <div class="flex-grow p-4">
            <textarea id="inputText" rows="6" class="w-full p-4 border border-[var(--card-border)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--button-bg)] transition-all resize-none text-[var(--text-color)] bg-[var(--chat-bot-msg)]" placeholder="Enter text here..."></textarea>
            <div class="flex items-center justify-between mt-4">
                <button id="translateBtn" class="bg-[var(--button-bg)] text-white font-semibold py-2 px-4 rounded-full shadow-md hover:bg-[var(--button-hover)] transition-colors focus:outline-none focus:ring-2 focus:ring-[var(--button-bg)] focus:ring-offset-2">പരിഭാഷ ചെയ്യുക</button>
                <div id="loadingIndicator" class="hidden"><div class="loading-animation"></div></div>
            </div>
            <textarea id="outputText" rows="6" readonly class="mt-4 w-full p-4 border border-[var(--card-border)] rounded-lg bg-[var(--chat-bot-msg)] resize-none text-[var(--text-color)]" placeholder="Translation will appear here..."></textarea>
        </div>
    </aside>

    <!-- Chatbot Sidebar -->
    <aside id="chat-sidebar" class="chat-sidebar">
        <div class="flex justify-between items-center p-4 bg-[var(--chat-bg)] rounded-t-3xl shadow-md border-b border-[var(--card-border)]">
             <img src="https://firebasestorage.googleapis.com/v0/b/app-maaveli-s-royal-portfoli-169c9.appspot.com/o/1000006025.jpg?alt=media&token=8cd55754-bf51-4ea2-99b7-9ee5706afb87" alt="Chatbot Icon" class="chatbot-icon rounded-full">
            <h3 class="text-2xl font-bold text-[var(--accent-color)]">Chat with Maaveli</h3>
            <button id="close-chat-btn" class="text-white text-3xl hover:text-gray-400 transition-colors">&times;</button>
        </div>
        <div id="chat-messages" class="chat-messages">
            <!-- Messages will be appended here -->
        </div>
        <div class="p-4 border-t border-[var(--card-border)] bg-[var(--chat-bg)]">
            <div class="flex space-x-2">
                <input type="text" id="chat-input" class="chat-input flex-grow p-3 rounded-full border border-[var(--card-border)] bg-[var(--chat-bot-msg)] focus:outline-none focus:ring-2 focus:ring-[var(--button-bg)]" placeholder="Ask the King a question...">
                <button id="send-chat-btn" class="p-3 bg-[var(--button-bg)] text-white rounded-full hover:bg-[var(--button-hover)] transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
                    </svg>
                </button>
            </div>
        </div>
    </aside>

    <!-- Recipe Modal -->
    <div id="recipe-modal" class="modal">
        <div class="modal-content recipe-modal">
            <div class="flex justify-between items-center mb-4">
                <h2 id="recipe-title" class="text-3xl font-bold text-amber-300">Royal Recipe</h2>
                <button id="close-recipe-modal" class="text-3xl">&times;</button>
            </div>
            <div id="recipe-content" class="text-lg leading-relaxed">
                <!-- Recipe content will be injected here -->
            </div>
        </div>
    </div>
    
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- Firebase Setup ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        
        let app, db, auth, storage;

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            storage = getStorage(app);

            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Firebase initialization failed:", error);
        }

        // --- DOM Elements ---
        const body = document.body;
        const chatSidebar = document.getElementById('chat-sidebar');
        const translatorSidebar = document.getElementById('translator-sidebar');
        const hamburgerMenu = document.getElementById('hamburger-menu');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const themeIcon = document.getElementById('theme-icon');

        // --- UI Interactions & Animations ---

        // Cosmic Light Canvas
        const cosmicCanvas = document.getElementById('cosmic-canvas');
        const ctx = cosmicCanvas.getContext('2d');
        let particles = [];

        function setupCosmicCanvas() {
            cosmicCanvas.width = window.innerWidth;
            cosmicCanvas.height = window.innerHeight;
            particles = [];
            if (!body.classList.contains('cosmic-mode')) return;
            let numberOfParticles = (cosmicCanvas.height * cosmicCanvas.width) / 9000;
            for (let i = 0; i < numberOfParticles; i++) {
                let size = Math.random() * 2 + 0.5;
                let x = Math.random() * (innerWidth - size * 2) + size;
                let y = Math.random() * (innerHeight - size * 2) + size;
                let directionX = (Math.random() * .4) - .2;
                let directionY = (Math.random() * .4) - .2;
                let color = 'rgba(209, 217, 226, 0.8)';
                particles.push({x, y, directionX, directionY, size, color});
            }
        }

        function animateCosmicCanvas() {
            requestAnimationFrame(animateCosmicCanvas);
            if (!body.classList.contains('cosmic-mode')) {
                ctx.clearRect(0, 0, innerWidth, innerHeight);
                return;
            }
            ctx.clearRect(0, 0, innerWidth, innerHeight);

            for (let i = 0; i < particles.length; i++) {
                let p = particles[i];
                p.x += p.directionX;
                p.y += p.directionY;

                if (p.x + p.size > cosmicCanvas.width || p.x - p.size < 0) p.directionX = -p.directionX;
                if (p.y + p.size > cosmicCanvas.height || p.y - p.size < 0) p.directionY = -p.directionY;
                
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fillStyle = p.color;
                ctx.fill();
            }
        }
        window.addEventListener('resize', setupCosmicCanvas);
        setupCosmicCanvas();
        animateCosmicCanvas();


        // Fade in elements on scroll
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                    observer.unobserve(entry.target);
                }
            });
        }, { threshold: 0.1 });
        document.querySelectorAll('.fade-in-up').forEach(el => observer.observe(el));

        // Flower falling animation
        const flowerContainer = document.getElementById('flower-container');
        const flowers = ['🌸', '🌺', '🌼', '🌷', '🌻'];
        function createFlower() {
            if (!flowerContainer) return;
            const flower = document.createElement('div');
            flower.classList.add('flower');
            flower.innerText = flowers[Math.floor(Math.random() * flowers.length)];
            flower.style.left = `${Math.random() * 100}vw`;
            flower.style.animationDuration = `${Math.random() * 5 + 5}s`; // 5 to 10 seconds
            flower.style.animationDelay = `${Math.random() * 5}s`;
            flowerContainer.appendChild(flower);
            setTimeout(() => flower.remove(), 10000);
        }
        Array.from({ length: 20 }).forEach(createFlower);
        setInterval(createFlower, 1000);

        // Click effect animation
        document.addEventListener('click', function(e) {
            const effect = document.createElement('div');
            effect.classList.add('click-effect');
            effect.innerText = '✨';
            body.appendChild(effect);
            effect.style.left = `${e.clientX}px`;
            effect.style.top = `${e.clientY}px`;
            setTimeout(() => effect.remove(), 1000);
        });

        // Slideshow functionality
        let slideIndex = 0;
        const slidesWrapper = document.getElementById('slides-wrapper');
        const slides = slidesWrapper.children;
        const totalSlides = slides.length;

        window.plusSlides = function(n) {
            slideIndex += n;
            if (slideIndex >= totalSlides) { slideIndex = 0; }
            if (slideIndex < 0) { slideIndex = totalSlides - 1; }
            slidesWrapper.style.transform = `translateX(-${slideIndex * 100}%)`;
        }

        // Auto-play slideshow
        setInterval(() => plusSlides(1), 5000);

        // Theme Toggle
        themeToggleBtn.addEventListener('click', () => {
            body.classList.toggle('cosmic-mode');
            const isCosmic = body.classList.contains('cosmic-mode');
            localStorage.setItem('theme', isCosmic ? 'cosmic' : 'default');
            themeIcon.innerHTML = isCosmic 
                ? `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />`
                : `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />`;
            setupCosmicCanvas();
        });
        if (localStorage.getItem('theme') === 'cosmic') {
            body.classList.add('cosmic-mode');
            themeIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />`;
            setupCosmicCanvas();
        }

        // --- Sidebars (Chat, Translator, Menu) ---
        function setupSidebar(toggleBtnId, sidebarId, closeBtnId) {
            const toggleBtn = document.getElementById(toggleBtnId);
            const sidebar = document.getElementById(sidebarId);
            const closeBtn = document.getElementById(closeBtnId);

            toggleBtn.addEventListener('click', () => sidebar.classList.add('open'));
            closeBtn.addEventListener('click', () => sidebar.classList.remove('open'));
        }
        setupSidebar('chat-toggle-btn', 'chat-sidebar', 'close-chat-btn');
        setupSidebar('translator-toggle-btn', 'translator-sidebar', 'close-translator-btn');
        setupSidebar('hamburger-btn', 'hamburger-menu', 'close-menu-btn');
        
        window.closeMenu = () => hamburgerMenu.classList.remove('open');
        window.openTranslator = () => {
            closeMenu();
            translatorSidebar.classList.add('open');
        }
        
        // --- Gemini API & Other API Calls ---
        const apiKey = ""; // Canvas will provide this
        
        async function makeApiCall(apiUrl, payload, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    console.error(`API call attempt ${i + 1} failed:`, error);
                    if (i === retries - 1) throw error;
                    await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                }
            }
        }
        
        // Chatbot functionality
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');
        let chatHistory = [];

        function addMessage(sender, text) {
            const messageEl = document.createElement('div');
            messageEl.classList.add('message', sender, 'new');
            messageEl.textContent = text;
            chatMessages.appendChild(messageEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        addMessage('bot', 'Greetings! I am Maaveli. How may I assist you, my dear subject?');
        
        async function handleChat() {
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;

            addMessage('user', userMessage);
            chatInput.value = '';
            addMessage('bot', '...');

            chatHistory.push({ role: "user", parts: [{ text: userMessage }] });

            try {
                const systemPrompt = "You are King Mahabali (Maaveli), a just, wise, and benevolent mythological king from Kerala, India. You are speaking to your subjects. Your tone should be regal, kind, a little bit humorous, and filled with ancient wisdom. You are known for the Onam festival. Keep your answers concise and relevant to your persona.";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const payload = {
                    contents: chatHistory,
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                const result = await makeApiCall(apiUrl, payload);
                const botResponse = result.candidates[0].content.parts[0].text;
                chatHistory.push({ role: "model", parts: [{ text: botResponse }] });
                
                const lastMessage = chatMessages.lastElementChild;
                lastMessage.textContent = botResponse;

            } catch (error) {
                console.error('Chatbot API error:', error);
                 const lastMessage = chatMessages.lastElementChild;
                lastMessage.textContent = "Apologies, my royal connection seems to be weak. Please try again.";
            }
        }
        
        sendChatBtn.addEventListener('click', handleChat);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleChat();
        });

        // Translator functionality
        const translateBtn = document.getElementById('translateBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const inputText = document.getElementById('inputText');
        const outputText = document.getElementById('outputText');

        translateBtn.addEventListener('click', async () => {
            const textToTranslate = inputText.value.trim();
            if (!textToTranslate) return;

            loadingIndicator.classList.remove('hidden');
            translateBtn.disabled = true;
            outputText.value = '';

            try {
                const systemPrompt = "You are an expert translator. Translate the given text to Malayalam. Provide only the translated text, without any additional explanations or pleasantries.";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = {
                    contents: [{ parts: [{ text: textToTranslate }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };
                
                const result = await makeApiCall(apiUrl, payload);
                outputText.value = result.candidates[0].content.parts[0].text;

            } catch (error) {
                console.error('Translation API error:', error);
                outputText.value = "Translation failed. Please try again.";
            } finally {
                loadingIndicator.classList.add('hidden');
                translateBtn.disabled = false;
            }
        });
        
        // Recipe Modal
        const recipeModal = document.getElementById('recipe-modal');
        const recipeTitle = document.getElementById('recipe-title');
        const recipeContent = document.getElementById('recipe-content');
        
        document.getElementById('close-recipe-modal').addEventListener('click', () => recipeModal.classList.remove('open'));
        recipeModal.addEventListener('click', (e) => {
            if (e.target === recipeModal) recipeModal.classList.remove('open');
        });

        async function generateRecipe(prompt, title) {
            closeMenu();
            recipeModal.classList.add('open');
            recipeTitle.textContent = `Generating ${title}...`;
            recipeContent.innerHTML = `<div class="flex justify-center"><div class="loading-animation"></div></div>`;
            
            try {
                 const systemPrompt = "You are a master chef from Kerala specializing in traditional Onam Sadya dishes. Provide a clear, step-by-step recipe for the requested dish. Format your response with markdown for headings, lists, and bold text.";
                 const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                 const payload = {
                     contents: [{ parts: [{ text: prompt }] }],
                     systemInstruction: { parts: [{ text: systemPrompt }] },
                 };

                 const result = await makeApiCall(apiUrl, payload);
                 let htmlContent = result.candidates[0].content.parts[0].text
                    .replace(/### (.*)/g, '<h3 class="text-xl font-semibold mt-4 mb-2">$1</h3>')
                    .replace(/## (.*)/g, '<h2 class="text-2xl font-bold mt-6 mb-3">$1</h2>')
                    .replace(/\* \s*(.*)/g, '<li class="ml-6 list-disc">$1</li>')
                    .replace(/\n/g, '<br>');

                 recipeTitle.textContent = title;
                 recipeContent.innerHTML = htmlContent;

            } catch (error) {
                console.error('Recipe API error:', error);
                recipeContent.innerHTML = `<p>My apologies, the royal recipe book seems to be misplaced. Please try again later.</p>`;
            }
        }
        
        window.generatePayasamRecipe = () => generateRecipe('Parippu Payasam recipe', 'Parippu Payasam');
        window.generateSadyaRecipe = () => generateRecipe('A simple Onam Sadya plan with 5 essential dishes', 'Onam Sadya Plan');
        
        // Image Generator
        const imageLoading = document.getElementById('image-loading');
        const generatedImage = document.getElementById('generated-image');
        
        window.generateImage = async function() {
            const prompt = document.getElementById('art-prompt').value;
            if (!prompt) return;
            
            imageLoading.classList.remove('hidden');
            generatedImage.classList.add('hidden');
            
            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
                const payload = { instances: [{ prompt: `An epic, cinematic, fantasy art style image of: ${prompt}` }], parameters: { "sampleCount": 1 } };
                
                const result = await makeApiCall(apiUrl, payload);
                if (result.predictions && result.predictions[0]?.bytesBase64Encoded) {
                    generatedImage.src = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    generatedImage.classList.remove('hidden');
                } else {
                    throw new Error('No image data in response');
                }
            } catch (error) {
                console.error('Image generation error:', error);
                alert('Could not create the royal art. The muses are not cooperating today.');
            } finally {
                imageLoading.classList.add('hidden');
            }
        }

        // Text-to-Speech
        const ttsButton = document.getElementById('tts-button');
        const ttsLoading = document.getElementById('tts-loading');
        
        window.speakAboutTheKing = async function() {
            const textToSpeak = document.getElementById('about-text').textContent.trim();
            ttsButton.disabled = true;
            ttsLoading.classList.remove('hidden');

            try {
                 const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
                 const payload = {
                     contents: [{ parts: [{ text: `Say in a wise, regal, and slightly cheerful male voice: ${textToSpeak}` }] }],
                     generationConfig: {
                         responseModalities: ["AUDIO"],
                         speechConfig: {
                             voiceConfig: { prebuiltVoiceConfig: { voiceName: "Gacrux" } }
                         }
                     },
                     model: "gemini-2.5-flash-preview-tts"
                 };
                 
                 const result = await makeApiCall(apiUrl, payload);
                 const audioData = result.candidates[0].content.parts[0].inlineData.data;
                 const mimeType = result.candidates[0].content.parts[0].inlineData.mimeType;

                 if (audioData && mimeType.startsWith("audio/")) {
                    const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, 1, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    new Audio(audioUrl).play();
                 } else {
                    throw new Error("Invalid audio data received");
                 }

            } catch (error) {
                console.error('TTS error:', error);
                alert('My royal decree cannot be spoken at this moment. Please try again.');
            } finally {
                ttsButton.disabled = false;
                ttsLoading.classList.add('hidden');
            }
        }
        
        // --- Firebase Photo Uploader ---
        const photoInput = document.getElementById('onam-photo-video-input');
        const uploadBtn = document.getElementById('upload-photo-btn');
        const uploadStatus = document.getElementById('upload-status');
        const photosContainer = document.getElementById('uploaded-photos-container');

        uploadBtn.addEventListener('click', async () => {
            const file = photoInput.files[0];
            if (!file || !storage || !db) return;

            uploadStatus.innerHTML = `<div class="flex justify-center"><div class="loading-animation"></div></div> <p>Uploading...</p>`;
            
            try {
                const storageRef = ref(storage, `onam_photos/${Date.now()}_${file.name}`);
                await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(storageRef);
                
                await addDoc(collection(db, `/artifacts/${appId}/public/data/onam_photos`), {
                    imageUrl: downloadURL,
                    createdAt: serverTimestamp()
                });

                uploadStatus.textContent = 'Upload successful! The King is pleased.';
                photoInput.value = ''; // Clear input
            } catch (error) {
                console.error("Upload failed:", error);
                uploadStatus.textContent = 'Upload failed. Please try again.';
            }
        });
        
        if (db) {
            const photosQuery = query(collection(db, `/artifacts/${appId}/public/data/onam_photos`));
            onSnapshot(photosQuery, (snapshot) => {
                photosContainer.innerHTML = '';
                snapshot.forEach(doc => {
                    const photoData = doc.data();
                    const imgContainer = document.createElement('div');
                    imgContainer.classList.add('glass-card', 'p-2', 'transform', 'transition-transform', 'hover:scale-105');
                    imgContainer.innerHTML = `<img src="${photoData.imageUrl}" alt="Onam celebration" class="w-full h-auto object-cover rounded-xl">`;
                    photosContainer.prepend(imgContainer);
                });
            });
        }
        
        // --- Tic-Tac-Toe Game Logic ---
        const gameStatus = document.getElementById('game-status');
        const ticTacToeBoard = document.getElementById('tic-tac-toe-board');
        const restartGameBtn = document.getElementById('restart-game-btn');
        const cells = document.querySelectorAll('.cell');
        const modePvpBtn = document.getElementById('mode-pvp');
        const modePveBtn = document.getElementById('mode-pve');

        let gameActive = true;
        let currentPlayerSymbol = '🌸';
        let gameState = ["", "", "", "", "", "", "", "", ""];
        let gameMode = 'pvp'; // 'pvp' or 'pve'

        const playerOne = '🌸';
        const playerTwo = '☂️';

        const winningMessage = (player) => {
             if (gameMode === 'pve' && player === playerTwo) return `Maveli has won! A royal victory!`;
             return `Player ${player} has won!`;
        }
        const drawMessage = () => `The game is a draw! A worthy challenge!`;
        const currentPlayerTurnMessage = () => {
             if (gameMode === 'pve') {
                return currentPlayerSymbol === playerOne ? "Your turn (🌸)" : "Maveli is thinking...";
             }
             return `It's player ${currentPlayerSymbol}'s turn`;
        };

        const winningConditions = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8],
            [0, 3, 6], [1, 4, 7], [2, 5, 8],
            [0, 4, 8], [2, 4, 6]
        ];

        modePvpBtn.addEventListener('click', () => {
            gameMode = 'pvp';
            modePvpBtn.style.backgroundColor = 'var(--button-hover)';
            modePveBtn.style.backgroundColor = 'var(--button-bg)';
            handleRestartGame();
        });

        modePveBtn.addEventListener('click', () => {
            gameMode = 'pve';
            modePveBtn.style.backgroundColor = 'var(--button-hover)';
            modePvpBtn.style.backgroundColor = 'var(--button-bg)';
            handleRestartGame();
        });

        function handleCellClick(event) {
            const clickedCell = event.target;
            const clickedCellIndex = parseInt(clickedCell.getAttribute('data-cell-index'));

            if (gameState[clickedCellIndex] !== "" || !gameActive || (gameMode === 'pve' && currentPlayerSymbol === playerTwo)) {
                return;
            }

            handleCellPlayed(clickedCell, clickedCellIndex);
            handleResultValidation();

            if (gameMode === 'pve' && gameActive) {
                ticTacToeBoard.style.pointerEvents = 'none';
                gameStatus.innerHTML = currentPlayerTurnMessage();
                setTimeout(() => {
                    makeMaveliMove();
                    ticTacToeBoard.style.pointerEvents = 'auto';
                }, 1000);
            }
        }

        function handleCellPlayed(cell, index) {
            gameState[index] = currentPlayerSymbol;
            cell.innerHTML = currentPlayerSymbol;
        }

        function handlePlayerChange() {
            currentPlayerSymbol = currentPlayerSymbol === playerOne ? playerTwo : playerOne;
            gameStatus.innerHTML = currentPlayerTurnMessage();
        }

        function handleResultValidation() {
            let roundWon = false;
            let winningPlayer = '';
            for (let i = 0; i < winningConditions.length; i++) {
                const winCondition = winningConditions[i];
                let a = gameState[winCondition[0]];
                let b = gameState[winCondition[1]];
                let c = gameState[winCondition[2]];
                if (a === '' || b === '' || c === '') continue;
                if (a === b && b === c) {
                    roundWon = true;
                    winningPlayer = a;
                    break;
                }
            }

            if (roundWon) {
                gameStatus.innerHTML = winningMessage(winningPlayer);
                gameActive = false;
                return;
            }

            if (!gameState.includes("")) {
                gameStatus.innerHTML = drawMessage();
                gameActive = false;
                return;
            }

            handlePlayerChange();
        }

        function makeMaveliMove() {
            if (!gameActive) return;
            const bestMove = findBestMove();
            if(bestMove === -1) return; // No moves left
            const cellToPlay = document.querySelector(`.cell[data-cell-index='${bestMove}']`);
            handleCellPlayed(cellToPlay, bestMove);
            handleResultValidation();
        }

        function findBestMove() {
            // 1. Win if possible
            for (let i = 0; i < 9; i++) {
                if (gameState[i] === '') {
                    gameState[i] = playerTwo;
                    if (checkWinner(playerTwo)) { gameState[i] = ''; return i; }
                    gameState[i] = '';
                }
            }
            // 2. Block if necessary
            for (let i = 0; i < 9; i++) {
                if (gameState[i] === '') {
                    gameState[i] = playerOne;
                    if (checkWinner(playerOne)) { gameState[i] = ''; return i; }
                    gameState[i] = '';
                }
            }
            // 3. Take center
            if (gameState[4] === '') return 4;
            // 4. Take corner
            const corners = [0, 2, 6, 8];
            const availableCorners = corners.filter(i => gameState[i] === '');
            if (availableCorners.length > 0) return availableCorners[Math.floor(Math.random() * availableCorners.length)];
            
            // 5. Take side
            return gameState.indexOf('');
        }

        function checkWinner(player) {
            return winningConditions.some(condition => {
                return condition.every(index => gameState[index] === player);
            });
        }

        function handleRestartGame() {
            gameActive = true;
            currentPlayerSymbol = playerOne;
            gameState = ["", "", "", "", "", "", "", "", ""];
            cells.forEach(cell => cell.innerHTML = "");
            ticTacToeBoard.style.pointerEvents = 'auto';
            gameStatus.innerHTML = currentPlayerTurnMessage();
        }

        ticTacToeBoard.addEventListener('click', handleCellClick);
        restartGameBtn.addEventListener('click', handleRestartGame);
        
        gameStatus.innerHTML = currentPlayerTurnMessage();
        modePvpBtn.click();

        // --- NEW Gemini Features ---
        const calendarBtn = document.getElementById('generate-calendar-btn');
        const calendarContent = document.getElementById('calendar-content');
        const gamesBtn = document.getElementById('generate-games-btn');
        const gamesContent = document.getElementById('games-content');

        calendarBtn.addEventListener('click', async () => {
            calendarContent.innerHTML = `<div class="flex justify-center"><div class="loading-animation"></div></div>`;
            calendarBtn.disabled = true;

            try {
                const prompt = "Using Google Search, find and list the main dates for the Onam festival in 2026. List the main 10 days from Atham to Thiruvonam with their corresponding dates.";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    tools: [{ "google_search": {} }],
                };

                const result = await makeApiCall(apiUrl, payload);
                const calendarText = result.candidates[0].content.parts[0].text;
                calendarContent.innerHTML = calendarText.replace(/\* /g, '<br>').replace(/\n/g, '<br>');

            } catch (error) {
                console.error('Calendar generation error:', error);
                calendarContent.textContent = 'My apologies, the royal astrologers are unavailable. Please try again.';
            } finally {
                calendarBtn.disabled = false;
            }
        });

        gamesBtn.addEventListener('click', async () => {
            gamesContent.innerHTML = `<div class="flex justify-center"><div class="loading-animation"></div></div>`;
            gamesBtn.disabled = true;

            try {
                const prompt = "Describe three traditional Onam games (Onakkalikal). For each game, provide a heading, a brief description of how to play, and the rules. Format it nicely with markdown.";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };

                const result = await makeApiCall(apiUrl, payload);
                const gamesText = result.candidates[0].content.parts[0].text;
                
                let htmlContent = gamesText
                    .replace(/### (.*)/g, '<h3 class="text-xl font-semibold mt-4 mb-2">$1</h3>')
                    .replace(/## (.*)/g, '<h2 class="text-2xl font-bold mt-6 mb-3">$1</h2>')
                    .replace(/\* \s*(.*)/g, '<li class="ml-6 list-disc text-left">$1</li>')
                    .replace(/\n/g, '<br>');
                
                gamesContent.innerHTML = `<div class="text-left">${htmlContent}</div>`;
            } catch (error) {
                console.error('Game suggestion error:', error);
                gamesContent.textContent = 'The royal game master is busy. Please ask for suggestions later.';
            } finally {
                gamesBtn.disabled = false;
            }
        });

        // --- NEW Boat Race Game ---
        const startRaceBtn = document.getElementById('start-race-btn');
        const raceTrack = document.getElementById('race-track');
        const raceResult = document.getElementById('race-result');
        const boatColors = ['Red', 'Green', 'Blue', 'Yellow'];

        startRaceBtn.addEventListener('click', () => {
            startRaceBtn.disabled = true;
            raceResult.textContent = '';
            raceTrack.innerHTML = '';
            let boats = [];
            let maxDuration = 0;

            for (let i = 0; i < 4; i++) {
                const boat = document.createElement('div');
                boat.textContent = '🛶';
                boat.classList.add('boat');
                boat.style.top = `${20 + i * 20}%`;
                const duration = Math.random() * 2 + 3; // Race time between 3 and 5 seconds
                if(duration > maxDuration) maxDuration = duration;
                boat.style.transitionDuration = `${duration}s`;
                raceTrack.appendChild(boat);
                boats.push({el: boat, duration: duration, color: boatColors[i]});
            }

            requestAnimationFrame(() => {
                 boats.forEach(b => b.el.classList.add('racing'));
            });
            
            setTimeout(() => {
                let winner = boats.reduce((prev, current) => (prev.duration < current.duration) ? prev : current);
                raceResult.textContent = `The ${winner.color} boat wins the royal cup!`;
                startRaceBtn.disabled = false;
            }, (maxDuration * 1000) + 100);
        });
        
         // --- NEW Contact Form with Firebase ---
        const contactForm = document.getElementById('contact-form');
        const contactStatus = document.getElementById('contact-status');

        contactForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!db) {
                contactStatus.textContent = "Database connection not available.";
                return;
            }
            const name = contactForm.name.value;
            const message = contactForm.message.value;
            contactStatus.textContent = "Sending your wish to the King...";
            
            try {
                await addDoc(collection(db, `/artifacts/${appId}/public/data/royal_wishes`), {
                    name: name,
                    message: message,
                    sentAt: serverTimestamp()
                });
                contactStatus.textContent = "Your message has been received by the royal court!";
                contactForm.reset();
            } catch(error) {
                console.error("Error sending message:", error);
                contactStatus.textContent = "A messenger hawk got lost. Please try again.";
            }
        });


        // --- Helper Functions for TTS ---
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, numChannels, sampleRate) {
            const buffer = new ArrayBuffer(44 + pcmData.length * 2);
            const view = new DataView(buffer);
            const writeString = (view, offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            const byteRate = sampleRate * numChannels * 2;
            const blockAlign = numChannels * 2;

            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcmData.length * 2, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, pcmData.length * 2, true);

            for (let i = 0; i < pcmData.length; i++) {
                view.setInt16(44 + i * 2, pcmData[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }
    </script>
</body>
</html> 